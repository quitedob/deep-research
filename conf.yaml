# -*- coding: utf-8 -*-
# Deep Research 统一配置文件 - 智能路由版
# 
# 此配置文件支持智能路由系统，自动选择最佳模型和工作流

# --- LLM 后端配置 ---
# 主要LLM后端: DOUBAO (云端) | OLLAMA (本地) | DEEPSEEK (云端) | KIMI (云端)
# 系统会根据任务类型和可用性自动选择最佳提供者
PRIMARY_LLM_BACKEND: "DOUBAO"  # 优先使用的后端（默认：豆包）
FALLBACK_LLM_BACKEND: "KIMI"  # 备用后端（Kimi 联网搜索）
SECONDARY_FALLBACK: "DEEPSEEK"  # 第二备用（DeepSeek 推理）

# --- Doubao (豆包) 配置 ---
DOUBAO_BASE_URL: "https://ark.cn-beijing.volces.com/api/v3"
DOUBAO_MODEL: "doubao-seed-1-6-flash-250615"  # 默认模型（快速响应，支持联网搜索）
DOUBAO_VISION_MODEL: "doubao-1-5-vision-pro-250328"  # 视觉理解模型
# DOUBAO_API_KEY: 通过环境变量设置
# DOUBAO_ENDPOINT_ID: 通过环境变量设置（可选）

# --- Kimi (月之暗面) 配置 ---
KIMI_BASE_URL: "https://api.moonshot.cn/v1"
KIMI_MODEL: "moonshot-v1-8k"  # 默认模型
KIMI_LONG_CONTEXT_MODEL: "moonshot-v1-128k"  # 长上下文模型
# KIMI_API_KEY: 通过环境变量设置

# --- 联网搜索配置 ---
DEFAULT_SEARCH_PROVIDER: "doubao"  # 默认搜索提供商: doubao | kimi

# --- Ollama 本地模型配置 ---
OLLAMA_BASE_URL: "http://localhost:11434"
OLLAMA_SMALL_MODEL: "gemma3:4b"     # 用于简单聊天、路由分类
OLLAMA_LARGE_MODEL: "qwen3:32b"     # 用于复杂推理、研究任务
OLLAMA_VISION_MODEL: "qwen2.5vl:7b" # 用于多模态任务

# Ollama连接配置
OLLAMA_CONNECTION_TIMEOUT: 30.0
OLLAMA_READ_TIMEOUT: 120.0
OLLAMA_RETRY_ATTEMPTS: 3

# --- DeepSeek API 配置 ---
# 支持多种模型，根据任务类型自动选择
DEEPSEEK_BASE_URL: "https://api.deepseek.com/v1"
DEEPSEEK_ENABLE_OFF_PEAK_OPTIMIZATION: true  # 启用错峰优化

# DeepSeek模型映射
DEEPSEEK_MODELS:
  chat: "deepseek-chat"        # 通用对话、数据分析
  reasoner: "deepseek-reasoner"  # 深度推理、复杂分析

# --- ZhipuAI (智谱AI) 配置 ---
# 支持多种GLM模型，具备强大的搜索和推理能力
ZHIPUAI_BASE_URL: "https://open.bigmodel.cn/api/paas/v4"
ZHIPUAI_ENABLE_VISION: true  # 启用视觉功能

# ZhipuAI模型映射
ZHIPUAI_MODELS:
  chat: "glm-4.5-air"                     # 默认聊天模型（高性价比）
  reasoning: "glm-4.6"                     # 推理模型（旗舰，最强性能）
  vision: "glm-4.1v-thinking-flash"        # 视觉模型（免费，多模态推理）
  search: "glm-4.5-flash"                  # 搜索模型（免费，网络搜索）
  free: "glm-4.5-flash"                    # 免费模型（快速响应）
  premium: "glm-4.6"                       # 旗舰模型（最高质量）
  cost_effective: "glm-4.5-air"            # 高性价比模型

# ZhipuAI搜索引擎配置
ZHIPUAI_SEARCH_ENGINES:
  search_std: "基础版（智谱AI自研）"        # 基础版，性价比极高
  search_pro: "高级版（智谱AI自研）"        # 高级版，多引擎协作
  search_pro_sogou: "搜狗"                  # 搜狗，覆盖腾讯生态
  search_pro_quark: "夸克"                  # 夸克，精准触达垂直内容

ZHIPUAI_DEFAULT_SEARCH_ENGINE: "search_pro"  # 默认搜索引擎
ZHIPUAI_MAX_SEARCH_RESULTS: 10              # 最大搜索结果数

# DeepSeek任务类型到temperature的映射
DEEPSEEK_TEMPERATURE_MAP:
  code: 0.0          # 代码生成/数学解题
  math: 0.0          # 数学问题
  analysis: 1.0      # 数据分析
  chat: 1.3          # 通用对话
  translation: 1.3   # 翻译任务
  creative: 1.5      # 创意写作/诗歌
  poetry: 1.5        # 诗歌创作

# --- 智能路由配置 ---
# 根据任务类型配置提供者优先级 - 平衡所有四个提供商
PROVIDER_PRIORITY:
  triage: ["ollama", "doubao", "zhipuai", "deepseek"]      # 路由分类：本地优先，云服务备用
  simple_chat: ["ollama", "zhipuai", "doubao", "deepseek"] # 简单聊天：本地免费优先
  code: ["deepseek", "zhipuai", "ollama", "doubao"]        # 代码任务：DeepSeek最强，ZhipuAI次之
  reasoning: ["zhipuai", "deepseek", "ollama", "doubao"]   # 推理任务：ZhipuAI GLM-4.6旗舰
  research: ["zhipuai", "doubao", "kimi", "deepseek", "ollama"]    # 研究任务：搜索能力优先
  analysis: ["zhipuai", "doubao", "deepseek", "kimi", "ollama"]   # 分析任务：平衡各提供商优势
  creative: ["zhipuai", "doubao", "deepseek", "ollama"]    # 创意任务：ZhipuAI和Doubao
  vision: ["zhipuai", "doubao", "ollama", "deepseek"]        # 视觉任务：ZhipuAI免费，Doubao专业
  search: ["zhipuai", "doubao", "kimi", "deepseek", "ollama"]   # 搜索任务：集成搜索能力优先
  general: ["ollama", "zhipuai", "doubao", "deepseek"]     # 通用任务：本地优先，云端备用

# 路由置信度阈值
TRIAGE_CONFIDENCE_THRESHOLD: 0.7  # 低于此置信度将使用更强模型

# --- 全局 LLM 模型配置（向后兼容） ---
# 这些配置主要用于不支持智能路由的旧组件
BASIC_MODEL:
  model_name: "deepseek-chat"
  temperature: 1.0
  max_tokens: 4000

REASONING_MODEL:
  model_name: "deepseek-reasoner"
  temperature: 1.0
  max_tokens: 32000

VISION_MODEL:
  model_name: "qwen2.5vl:7b"
  temperature: 0.0
  max_tokens: 4000

# --- 搜索与记忆配置 ---
# 默认搜索引擎（已废弃，使用 DEFAULT_SEARCH_PROVIDER）
SEARCH_ENGINE: "DOUBAO"

# 是否启用 Mem0 长期记忆
ENABLE_MEM0: true
MEM0_INDEX_PATH: "./data/mem0_index"

# --- RAG 与向量知识库配置 ---
RAG_INDEX_PATH: "./data/rag_documents"
VECTOR_STORE_PATH: "./data/vector_store"

# --- 融合检索配置 ---
ENABLE_FUSED_SEARCH: true
SEARCH_CACHE_TTL: 3600  # 搜索结果缓存时间（秒）
FUSED_SEARCH_ENGINES: ["TAVILY", "ARXIV", "RAG"]

# --- 上下文管理配置 ---
# 自动分块处理长上下文
ENABLE_CONTEXT_SPLITTING: true
CONTEXT_SPLIT_THRESHOLD: 0.8  # 超过上下文限制的80%时开始分块
MAX_CONTEXT_CHUNKS: 5         # 最大分块数量

# --- 输出配置 ---
OUTPUT_DIR: "./output_reports"

# --- 执行配置 ---
MAX_SEARCH_RESULTS: 10

# --- 工作流配置 ---
# 不同工作流的特定配置
WORKFLOWS:
  main:
    enable_background_investigation: true
    max_plan_iterations: 3
    enable_human_feedback: false  # 生产环境建议关闭

  ppt:
    default_template: "modern"
    max_slides: 20
    enable_charts: true
    # PPT生成专用的提供商优先级
    provider_priority: ["deepseek", "ollama", "domestic"]
    # PPT生成专用的模型配置
    models:
      outline_generation: "deepseek-chat"  # 大纲生成使用聊天模型
      content_generation: "deepseek-reasoner"  # 内容生成使用推理模型
      fallback_model: "ollama:qwen3:7b"  # 降级到本地模型
    # PPT输出配置
    output_dir: "./data/ppt_exports"
    image_cache_dir: "./data/ppt_images"
    # 图片生成配置
    image_service:
      enable_cache: true
      cache_ttl_days: 7
      max_image_size: "1920x1080"
      supported_formats: ["jpg", "png"]
    # 质量控制
    quality_control:
      min_dsl_validation_score: 0.8
      max_retries: 3
      enable_proofreading: true

  podcast:
    default_voice: "female"
    audio_format: "mp3"
    sample_rate: 44100

  prose:
    default_style: "academic"
    max_length: 5000

# --- 性能优化配置 ---
# 并发和性能相关设置
MAX_CONCURRENT_REQUESTS: 10
REQUEST_TIMEOUT: 300  # 秒
ENABLE_CACHING: true
CACHE_TTL: 1800  # 缓存过期时间（秒）

# 健康检查配置
HEALTH_CHECK_INTERVAL: 300  # 健康检查间隔（秒）
HEALTH_CHECK_TIMEOUT: 10    # 健康检查超时（秒）

# --- 日志配置 ---
LOG_LEVEL: "INFO"
LOG_FORMAT: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
ENABLE_REQUEST_LOGGING: true

# --- 安全配置 ---
# CORS配置 - 生产环境应从环境变量读取
# 注意：生产环境建议使用具体的域名，不要使用通配符
CORS_ALLOW_ORIGINS: "http://localhost:3000,http://localhost:8080"  # 逗号分隔的允许域名列表
CORS_ALLOW_CREDENTIALS: true

# 安全强化配置
CORS_ALLOW_METHODS: "GET,POST,PUT,DELETE,OPTIONS"
CORS_ALLOW_HEADERS: "Authorization,Content-Type,X-Requested-With,Accept,Accept-Encoding,Accept-Language,Cache-Control,Connection,Host,User-Agent,X-Request-ID"
CORS_MAX_AGE: 86400  # 24小时

# JWT配置（通过环境变量 DEEP_RESEARCH_SECURITY_SECRET_KEY 设置）
JWT_ACCESS_TOKEN_EXPIRE_MINUTES: 60
JWT_ALGORITHM: "HS256"

# API密钥配置（通过环境变量设置）
# DEEPSEEK_API_KEY: 通过环境变量设置
# MOONSHOT_API_KEY: 通过环境变量设置
# ZHIPUAI_API_KEY: 智谱AI API密钥（通过环境变量设置）
# DOUBAO_API_KEY: 豆包API密钥（通过环境变量设置）
# VOLCENGINE_TTS_APPID: 通过环境变量设置
# VOLCENGINE_TTS_ACCESS_TOKEN: 通过环境变量设置

# --- 实验性功能 ---
# 这些功能仍在开发中，可能不稳定
EXPERIMENTAL_FEATURES:
  enable_multimodal_routing: false  # 多模态路由
  enable_dynamic_model_selection: true  # 动态模型选择
  enable_cost_optimization: true   # 成本优化
  enable_performance_monitoring: false  # 性能监控

# --- 应用基础配置 ---
APP_NAME: "Deep Research Platform"
APP_VERSION: "1.0.0"
ENVIRONMENT: "development"
DEBUG: true
HOST: "0.0.0.0"
PORT: 8000
ENABLE_RELOAD: true

# --- 数据库配置 ---
DATABASE_URL: "${DATABASE_URL:postgresql+asyncpg://postgres:1234@localhost:5432/deep_research}"
AUTO_CREATE_TABLES: true  # 开发环境自动创建表

# --- Redis 配置 ---
REDIS_URL: "${REDIS_URL:redis://localhost:6379}"

# --- JWT 配置 ---
# 密钥通过环境变量 DEEP_RESEARCH_SECURITY_SECRET_KEY 设置
ALGORITHM: "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES: 30

# --- Stripe 配置 ---
STRIPE_SECRET_KEY: "${STRIPE_SECRET_KEY:}"
STRIPE_WEBHOOK_SECRET: "${STRIPE_WEBHOOK_SECRET:}"
STRIPE_PRICE_ID: "${STRIPE_PRICE_ID:}"
FRONTEND_URL: "${FRONTEND_URL:http://localhost:3000}"

# --- 配额配置 ---
FREE_TIER_LIFETIME_LIMIT: 5
SUBSCRIBED_TIER_HOURLY_LIMIT: 5
QUOTA_WINDOW_SIZE: 3600

# --- 文件上传配置 ---
MAX_FILE_SIZE: 10485760  # 10MB
ALLOWED_FILE_TYPES: ".docx,.doc,.txt,.md,.pdf,.ppt,.pptx"
UPLOAD_DIR: "./uploads"
TEMP_DIR: "./temp"

# --- 向量维度配置 ---
VECTOR_DIMENSION: 1536

# --- 任务队列配置 ---
TASK_QUEUE_TYPE: "redis"
TASK_QUEUE_URL: "${TASK_QUEUE_URL:redis://localhost:6379}"
MAX_WORKERS: 4

# --- 对话记忆配置 ---
ENABLE_CONVERSATION_MEMORY: true
MEMORY_MAX_TOKENS: 4000
MEMORY_TTL_HOURS: 24

# --- OCR 配置 ---
OCR_PROVIDER: "doubao"  # 使用 Doubao 进行 OCR
OCR_MODEL: "doubao-seed-1-6-flash-250615"  # 快速识别模型

# --- 版本信息 ---
CONFIG_VERSION: "2.1.0"
LAST_UPDATED: "2025-01-16"
